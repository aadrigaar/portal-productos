<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Productos</title>
    <style>
        /* Estilos b√°sicos */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            line-height: 1.6;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            margin-bottom: 1rem;
            font-size: 2rem;
        }
        
        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .nav-btn, .auth-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .nav-btn:hover, .auth-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .nav-btn.active {
            background: rgba(255,255,255,0.4);
            font-weight: bold;
        }
        
        /* Main Content */
        .main-content {
            padding: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            min-height: calc(100vh - 120px);
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }

/* Secci√≥n de usuarios conectados en el chat */
.chat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #667eea;
    color: white;
    padding: 1rem 1.5rem;
}

.chat-title {
    font-size: 1.5rem;
    font-weight: bold;
}

.online-users {
    position: relative;
    cursor: pointer;
}

.online-users-badge {
    background: #28a745;
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
}

.online-users-badge:hover {
    background: #218838;
    transform: translateY(-2px);
}

.online-users-list {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 10px;
    padding: 1rem;
    min-width: 200px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    z-index: 1000;
    display: none;
}

.online-users:hover .online-users-list {
    display: block;
    animation: fadeIn 0.3s ease;
}

.online-users-list h4 {
    margin: 0 0 0.75rem 0;
    color: #333;
    font-size: 1rem;
    border-bottom: 1px solid #eee;
    padding-bottom: 0.5rem;
}

.user-list {
    list-style: none;
    margin: 0;
    padding: 0;
    max-height: 200px;
    overflow-y: auto;
}

.user-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0;
    border-bottom: 1px solid #f5f5f5;
}

.user-item:last-child {
    border-bottom: none;
}

.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 0.8rem;
}

.user-info {
    flex: 1;
}

.user-name {
    font-weight: 600;
    color: #333;
    font-size: 0.9rem;
}

.user-role {
    font-size: 0.7rem;
    color: #666;
    text-transform: uppercase;
}

.user-role.admin {
    color: #dc3545;
    font-weight: bold;
}

.user-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #28a745;
    animation: pulse 2s infinite;
}

.no-users {
    text-align: center;
    color: #666;
    font-style: italic;
    padding: 1rem 0;
}

/* Animaci√≥n para el indicador de estado */
@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* Responsive */
@media (max-width: 768px) {
    .chat-header {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .online-users-list {
        right: -50%;
    }
}

        /* Puntos de animaci√≥n para "escribiendo" */
.typing-dots {
    display: inline-block;
}

.typing-dots span {
    animation: typingDot 1.4s infinite;
    opacity: 0;
}

.typing-dots span:nth-child(1) {
    animation-delay: 0s;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typingDot {
    0%, 60%, 100% {
        opacity: 0;
    }
    30% {
        opacity: 1;
    }
}
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Home Section */
        .hero {
            text-align: center;
            padding: 3rem 2rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .hero h2 {
            color: #667eea;
            margin-bottom: 1rem;
            font-size: 2.5rem;
        }
        
        .hero p {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 3rem;
        }
        
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .feature-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .feature-card:hover {
            transform: translateY(-5px);
        }
        
        .feature-card h3 {
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        /* Auth Forms */
        .auth-form {
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .auth-form h2 {
            text-align: center;
            margin-bottom: 2rem;
            color: #667eea;
            font-size: 1.8rem;
        }
        
        .auth-form input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .auth-form input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .auth-form button {
            width: 100%;
            padding: 0.75rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s ease;
        }
        
        .auth-form button:hover {
            background: #5a6fd8;
        }
        
        .message {
            text-align: center;
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .message.error {
            background: #fee;
            color: #c33;
            border: 1px solid #f5c6cb;
        }
        
        .message.success {
            background: #efe;
            color: #363;
            border: 1px solid #c3e6cb;
        }
        
        /* Products Section */

        /* Buscador de productos */
.search-container {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
}

.search-header {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    align-items: center;
}

.search-input {
    flex: 1;
    min-width: 250px;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

.search-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
}

.search-filters {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #eee;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.filter-group label {
    font-weight: 600;
    color: #333;
    font-size: 0.9rem;
}

.filter-select, .filter-input {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.9rem;
}

.filter-input:focus {
    outline: none;
    border-color: #667eea;
}

.search-results-info {
    margin-top: 1rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 8px;
    text-align: center;
    color: #666;
    font-size: 0.9rem;
}

.no-results {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem;
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.no-results h3 {
    color: #666;
    margin-bottom: 1rem;
}

.price-range {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.price-range input {
    flex: 1;
}

.clear-filters {
    background: #6c757d;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    transition: background 0.3s ease;
}

.clear-filters:hover {
    background: #5a6268;
}

@media (max-width: 768px) {
    .search-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-input {
        min-width: auto;
    }
    
    .search-filters {
        grid-template-columns: 1fr;
    }
    
    .price-range {
        flex-direction: column;
    }
}

        .products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .products-header h2 {
            color: #333;
            font-size: 2rem;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .admin-badge {
            background: #dc3545;
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: bold;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }
        
        .product-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid #eee;
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }
        
        .product-card h3 {
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 1.3rem;
        }
        
        .product-card .description {
            color: #666;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .product-card .price {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            margin: 0.5rem 0;
        }
        
        .product-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 0.8rem;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s ease;
            font-size: 0.8rem;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        /* Chat Section */
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .chat-container h2 {
            background: #667eea;
            color: white;
            padding: 1.5rem;
            text-align: center;
            margin: 0;
            font-size: 1.5rem;
        }
        
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 1rem;
            border-bottom: 1px solid #eee;
            background: #fafafa;
        }
        
        .chat-message {
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            max-width: 70%;
            animation: messageSlide 0.3s ease;
        }
        
        @keyframes messageSlide {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .chat-message.own {
            background: #667eea;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.other {
            background: white;
            color: #333;
            border: 1px solid #eee;
            border-bottom-left-radius: 4px;
        }
        
        .chat-message.system {
            background: #f8f9fa;
            color: #666;
            font-style: italic;
            max-width: 100%;
            text-align: center;
            border: 1px dashed #dee2e6;
        }
        
        /* Indicador de escribiendo */
        .typing-indicator {
            padding: 0.5rem 1rem;
            font-style: italic;
            color: #666;
            font-size: 0.9rem;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 0.5rem 0;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        .chat-input-container {
            display: flex;
            padding: 1rem;
            gap: 0.5rem;
            background: white;
        }
        
        .chat-input-container input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .chat-input-container input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .chat-input-container button {
            padding: 0.75rem 1.5rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .chat-input-container button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }
        
        .chat-input-container button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .modal-content h3 {
            margin-bottom: 1.5rem;
            color: #667eea;
            font-size: 1.5rem;
        }
        
        .modal-content input,
        .modal-content textarea {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }
        
        .modal-content input:focus,
        .modal-content textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
        }
        
        .modal-content textarea {
            height: 100px;
            resize: vertical;
            font-family: inherit;
        }
        
        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .nav {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .products-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .chat-message {
                max-width: 85%;
            }
            
            .features {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <header class="header">
            <h1>üõçÔ∏è Portal de Productos</h1>
            <nav class="nav">
    <button onclick="showSection('homeSection')" class="nav-btn active">Inicio</button>
    <button onclick="showSection('productsSection')" class="nav-btn">Productos</button>
    <button onclick="showSection('chatSection')" class="nav-btn">Chat</button>
    <div id="authSection">
        <button onclick="showSection('loginSection')" class="auth-btn">Iniciar Sesi√≥n</button>
        <button onclick="showSection('registerSection')" class="auth-btn">Registrarse</button>
        <button onclick="logout()" class="auth-btn hidden" id="logoutBtn">Cerrar Sesi√≥n</button>
        <span id="userInfo" class="hidden"></span>
    </div>
</nav>
        </header>

        <!-- Secciones -->
        <main class="main-content">
            <!-- Secci√≥n Home -->
            <section id="homeSection" class="section active">
                <div class="hero">
                    <h2>Bienvenido al Portal de Productos</h2>
                    <p>Gestiona y explora nuestros productos exclusivos</p>
                    <div class="features">
                        <div class="feature-card">
                            <h3>üì¶ Gesti√≥n de Productos</h3>
                            <p>CRUD completo para administradores</p>
                        </div>
                        <div class="feature-card">
                            <h3>üîê Autenticaci√≥n JWT</h3>
                            <p>Sistema seguro de usuarios y roles</p>
                        </div>
                        <div class="feature-card">
                            <h3>üí¨ Chat en Tiempo Real</h3>
                            <p>Comunicaci√≥n instant√°nea con WebSockets</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Secci√≥n Login -->
            <section id="loginSection" class="section hidden">
                <div class="auth-form">
                    <h2>Iniciar Sesi√≥n</h2>
                    <form onsubmit="handleLogin(event)">
                        <input type="email" id="loginEmail" placeholder="Email" required>
                        <input type="password" id="loginPassword" placeholder="Contrase√±a" required>
                        <button type="submit">Ingresar</button>
                    </form>
                    <p id="loginMessage" class="message"></p>
                </div>
            </section>

            <!-- Secci√≥n Registro -->
            <section id="registerSection" class="section hidden">
                <div class="auth-form">
                    <h2>Registrarse</h2>
                    <form onsubmit="handleRegister(event)">
                        <input type="text" id="registerUsername" placeholder="Usuario" required>
                        <input type="email" id="registerEmail" placeholder="Email" required>
                        <input type="password" id="registerPassword" placeholder="Contrase√±a" required>
                        <button type="submit">Registrarse</button>
                    </form>
                    <p id="registerMessage" class="message"></p>
                </div>
            </section>

            <!-- Secci√≥n Productos -->
<section id="productsSection" class="section hidden">
    <div class="products-header">
        <h2>Cat√°logo de Productos</h2>
        <button onclick="showProductModal()" class="btn-primary hidden" id="addProductBtn">üëë Agregar Producto</button>
    </div>
    
    <!-- Buscador de Productos -->
    <div class="search-container">
        <div class="search-header">
            <input 
                type="text" 
                id="searchInput" 
                class="search-input" 
                placeholder="üîç Buscar productos por nombre o descripci√≥n..."
                onkeyup="handleSearch()"
            >
            <button onclick="toggleFilters()" class="btn-secondary" id="toggleFiltersBtn">
                üìä Filtros
            </button>
            <button onclick="clearFilters()" class="clear-filters" id="clearFiltersBtn" style="display: none;">
                üóëÔ∏è Limpiar
            </button>
        </div>
        
        <div class="search-filters hidden" id="searchFilters">
            <div class="filter-group">
                <label for="categoryFilter">üìÅ Categor√≠a</label>
                <select id="categoryFilter" class="filter-select" onchange="handleSearch()">
                    <option value="all">Todas las categor√≠as</option>
                    <option value="Electr√≥nicos">Electr√≥nicos</option>
                    <option value="Audio">Audio</option>
                    <option value="Wearables">Wearables</option>
                    <option value="Hogar">Hogar</option>
                    <option value="Deportes">Deportes</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="minPrice">üí∞ Precio M√≠nimo</label>
                <input 
                    type="number" 
                    id="minPrice" 
                    class="filter-input" 
                    placeholder="0.00" 
                    min="0" 
                    step="0.01"
                    onchange="handleSearch()"
                >
            </div>
            
            <div class="filter-group">
                <label for="maxPrice">üí∞ Precio M√°ximo</label>
                <input 
                    type="number" 
                    id="maxPrice" 
                    class="filter-input" 
                    placeholder="9999.99" 
                    min="0" 
                    step="0.01"
                    onchange="handleSearch()"
                >
            </div>
            
            <div class="filter-group">
                <label for="sortBy">üìä Ordenar por</label>
                <select id="sortBy" class="filter-select" onchange="handleSearch()">
                    <option value="name">Nombre A-Z</option>
                    <option value="nameDesc">Nombre Z-A</option>
                    <option value="priceAsc">Precio: Menor a Mayor</option>
                    <option value="priceDesc">Precio: Mayor a Menor</option>
                    <option value="newest">M√°s Recientes</option>
                    <option value="stock">Stock Disponible</option>
                </select>
            </div>
        </div>
        
        <div class="search-results-info" id="searchResultsInfo">
            Mostrando todos los productos
        </div>
    </div>
    
    <div id="productsList" class="products-grid">
        <!-- Productos se cargar√°n aqu√≠ -->
    </div>
</section>

            <!-- Modal para agregar/editar producto -->
            <div id="productModal" class="modal hidden">
                <div class="modal-content">
                    <h3 id="modalTitle">Agregar Producto</h3>
                    <form onsubmit="handleProductSubmit(event)" id="productForm">
                        <input type="text" id="productName" placeholder="Nombre" required>
                        <textarea id="productDescription" placeholder="Descripci√≥n" required></textarea>
                        <input type="number" id="productPrice" placeholder="Precio" step="0.01" required>
                        <input type="text" id="productCategory" placeholder="Categor√≠a" required>
                        <input type="number" id="productStock" placeholder="Stock" required>
                        <input type="text" id="productImage" placeholder="URL de imagen (opcional)">
                        <div class="modal-actions">
                            <button type="submit" class="btn-primary">Guardar</button>
                            <button type="button" onclick="hideProductModal()" class="btn-secondary">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Secci√≥n Chat -->
<!-- Secci√≥n Chat -->
<section id="chatSection" class="section hidden">
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-title">üí¨ Chat en Tiempo Real</div>
            <div class="online-users">
                <div class="online-users-badge" id="onlineUsersBadge">
                    <span>üë•</span>
                    <span id="onlineCount">0</span> conectados
                </div>
                <div class="online-users-list">
                    <h4>Usuarios Conectados</h4>
                    <ul class="user-list" id="userList">
                        <li class="no-users">No hay usuarios conectados</li>
                    </ul>
                </div>
            </div>
        </div>
        <div id="chatMessages" class="chat-messages">
            <div class="chat-message system">
                <strong>Sistema:</strong> ¬°Bienvenido al chat! Inicia sesi√≥n para comenzar a conversar.
            </div>
        </div>
        <div id="typingIndicator" class="typing-indicator hidden"></div>
        <div class="chat-input-container">
            <input type="text" id="chatInput" placeholder="Inicia sesi√≥n para escribir..." disabled>
            <button id="sendMessageBtn" onclick="sendMessage()" disabled>Enviar</button>
        </div>
    </div>
</section>
        </main>
    </div>

    <script>
        // ==================== VARIABLES GLOBALES ====================
        let currentUser = null;
        let socket = null;
        let currentEditingProduct = null;
        let typingTimer = null;
        let isTyping = false;

        // ==================== FUNCIONES DE USUARIOS CONECTADOS ====================

let onlineUsers = [];

// Funci√≥n para actualizar la lista de usuarios conectados
function updateOnlineUsers(data) {
    console.log('üë• Actualizando usuarios conectados:', data);
    
    onlineUsers = data.users || [];
    const onlineCount = data.count || 0;
    
    // Actualizar contador
    document.getElementById('onlineCount').textContent = onlineCount;
    
    // Actualizar lista de usuarios
    const userList = document.getElementById('userList');
    
    if (onlineCount === 0) {
        userList.innerHTML = '<li class="no-users">No hay usuarios conectados</li>';
        return;
    }
    
    userList.innerHTML = onlineUsers.map(user => `
        <li class="user-item">
            <div class="user-status"></div>
            <div class="user-avatar">
                ${user.username.charAt(0).toUpperCase()}
            </div>
            <div class="user-info">
                <div class="user-name">
                    ${user.username}
                    ${currentUser && user.username === currentUser.username ? ' (T√∫)' : ''}
                </div>
                <div class="user-role ${user.role === 'admin' ? 'admin' : ''}">
                    ${user.role === 'admin' ? 'üëë ADMIN' : 'üë§ USER'}
                </div>
            </div>
        </li>
    `).join('');
    
    // Actualizar badge con colores seg√∫n cantidad
    const badge = document.getElementById('onlineUsersBadge');
    if (onlineCount === 1) {
        badge.style.background = '#6c757d'; // Gris para 1 usuario
    } else if (onlineCount <= 3) {
        badge.style.background = '#28a745'; // Verde para 2-3 usuarios
    } else if (onlineCount <= 5) {
        badge.style.background = '#ffc107'; // Amarillo para 4-5 usuarios
        badge.style.color = '#212529';
    } else {
        badge.style.background = '#dc3545'; // Rojo para m√°s de 5 usuarios
    }
}

// Funci√≥n para mostrar notificaci√≥n de usuario conectado/desconectado
function showUserStatusNotification(username, action) {
    const chatMessages = document.getElementById('chatMessages');
    
    if (!chatMessages) return;
    
    const notification = document.createElement('div');
    notification.className = 'chat-message system';
    
    const icon = action === 'connected' ? '‚úÖ' : '‚ùå';
    const text = action === 'connected' ? 'se ha unido al chat' : 'ha abandonado el chat';
    
    notification.innerHTML = `
        <strong>Sistema:</strong> ${icon} <strong>${username}</strong> ${text}
        <div style="font-size: 0.7rem; opacity: 0.7; margin-top: 0.25rem;">
            Usuarios en l√≠nea: ${onlineUsers.length}
        </div>
    `;
    
    chatMessages.appendChild(notification);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Auto-eliminar despu√©s de 5 segundos
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.5s ease';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 500);
        }
    }, 5000);
}

        // ==================== FUNCIONES DE B√öSQUEDA ====================

let searchTimeout = null;
let currentFilters = {
    query: '',
    category: 'all',
    minPrice: '',
    maxPrice: '',
    sortBy: 'name'
};

function handleSearch() {
    // Debounce para evitar muchas llamadas API
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(performSearch, 500);
}

async function performSearch() {
    try {
        console.log('üîç Realizando b√∫squeda...');
        
        // Obtener valores actuales
        currentFilters.query = document.getElementById('searchInput').value;
        currentFilters.category = document.getElementById('categoryFilter').value;
        currentFilters.minPrice = document.getElementById('minPrice').value;
        currentFilters.maxPrice = document.getElementById('maxPrice').value;
        currentFilters.sortBy = document.getElementById('sortBy').value;
        
        // Construir query string
        const params = new URLSearchParams();
        
        if (currentFilters.query) params.append('q', currentFilters.query);
        if (currentFilters.category !== 'all') params.append('category', currentFilters.category);
        if (currentFilters.minPrice) params.append('minPrice', currentFilters.minPrice);
        if (currentFilters.maxPrice) params.append('maxPrice', currentFilters.maxPrice);
        
        const queryString = params.toString();
        const url = queryString ? `/api/products/search?${queryString}` : '/api/products';
        
        console.log('üîç URL de b√∫squeda:', url);
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        
        let products = await response.json();
        
        // Aplicar ordenamiento en el frontend
        products = sortProducts(products, currentFilters.sortBy);
        
        // Mostrar resultados
        displayProducts(products);
        updateSearchInfo(products.length);
        
        // Mostrar/ocultar bot√≥n limpiar
        const hasActiveFilters = currentFilters.query || 
                               currentFilters.category !== 'all' || 
                               currentFilters.minPrice || 
                               currentFilters.maxPrice;
        
        document.getElementById('clearFiltersBtn').style.display = 
            hasActiveFilters ? 'block' : 'none';
            
    } catch (error) {
        console.error('‚ùå Error en b√∫squeda:', error);
        // Fallback a carga normal de productos
        loadProducts();
    }
}

function sortProducts(products, sortBy) {
    console.log('üìä Ordenando productos por:', sortBy);
    
    return [...products].sort((a, b) => {
        switch (sortBy) {
            case 'name':
                return a.name.localeCompare(b.name);
            case 'nameDesc':
                return b.name.localeCompare(a.name);
            case 'priceAsc':
                return (a.price || 0) - (b.price || 0);
            case 'priceDesc':
                return (b.price || 0) - (a.price || 0);
            case 'newest':
                return new Date(b.createdAt) - new Date(a.createdAt);
            case 'stock':
                return (b.stock || 0) - (a.stock || 0);
            default:
                return 0;
        }
    });
}

function updateSearchInfo(resultCount) {
    const infoEl = document.getElementById('searchResultsInfo');
    const hasFilters = currentFilters.query || 
                      currentFilters.category !== 'all' || 
                      currentFilters.minPrice || 
                      currentFilters.maxPrice;
    
    if (hasFilters) {
        let filterText = [];
        
        if (currentFilters.query) filterText.push(`"${currentFilters.query}"`);
        if (currentFilters.category !== 'all') filterText.push(`categor√≠a: ${currentFilters.category}`);
        if (currentFilters.minPrice) filterText.push(`precio ‚â• $${currentFilters.minPrice}`);
        if (currentFilters.maxPrice) filterText.push(`precio ‚â§ $${currentFilters.maxPrice}`);
        
        infoEl.innerHTML = `
            üîç <strong>${resultCount} productos encontrados</strong> 
            <span style="color: #666; font-size: 0.8em;">(filtros: ${filterText.join(', ')})</span>
        `;
    } else {
        infoEl.textContent = `Mostrando ${resultCount} productos`;
    }
}

function toggleFilters() {
    const filtersEl = document.getElementById('searchFilters');
    const toggleBtn = document.getElementById('toggleFiltersBtn');
    
    if (filtersEl.classList.contains('hidden')) {
        filtersEl.classList.remove('hidden');
        toggleBtn.textContent = 'üìä Ocultar Filtros';
    } else {
        filtersEl.classList.add('hidden');
        toggleBtn.textContent = 'üìä Filtros';
    }
}

function clearFilters() {
    console.log('üóëÔ∏è Limpiando filtros...');
    
    // Limpiar inputs
    document.getElementById('searchInput').value = '';
    document.getElementById('categoryFilter').value = 'all';
    document.getElementById('minPrice').value = '';
    document.getElementById('maxPrice').value = '';
    document.getElementById('sortBy').value = 'name';
    
    // Resetear filtros
    currentFilters = {
        query: '',
        category: 'all',
        minPrice: '',
        maxPrice: '',
        sortBy: 'name'
    };
    
    // Ocultar bot√≥n limpiar
    document.getElementById('clearFiltersBtn').style.display = 'none';
    
    // Recargar productos sin filtros
    loadProducts();
}

// Actualizar la funci√≥n loadProducts existente para usar la b√∫squeda
async function loadProducts() {
    try {
        console.log('üì¶ Cargando productos...');
        await performSearch(); // Usar la funci√≥n de b√∫squeda que ahora maneja todo
    } catch (error) {
        console.error('‚ùå Error cargando productos:', error);
        console.log('üîÑ Usando productos de ejemplo...');
        displayProducts(getExampleProducts());
    }
}

        // ==================== FUNCIONES DE NAVEGACI√ìN ====================
function showSection(sectionId) {
    console.log('üì± Mostrando secci√≥n:', sectionId);
    
    // Definir secciones p√∫blicas y privadas
    const publicSections = ['homeSection', 'loginSection', 'registerSection'];
    const privateSections = ['productsSection', 'chatSection'];
    
    // Verificar si la secci√≥n es privada y el usuario no est√° autenticado
    if (privateSections.includes(sectionId) && !currentUser) {
        console.log('üö´ Acceso denegado a secci√≥n privada:', sectionId);
        alert('üîê Debes iniciar sesi√≥n para acceder a esta secci√≥n');
        showSection('loginSection');
        return;
    }
    
    // Ocultar todas las secciones
    document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
        section.classList.add('hidden');
    });
    
    // Remover active de todos los botones
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Mostrar secci√≥n seleccionada
    const section = document.getElementById(sectionId);
    if (section) {
        section.classList.remove('hidden');
        section.classList.add('active');
        console.log('‚úÖ Secci√≥n mostrada correctamente');
    } else {
        console.error('‚ùå Secci√≥n no encontrada:', sectionId);
        return;
    }
    
    // Activar bot√≥n correspondiente
    const btnMap = {
        'homeSection': 'homeBtn',
        'productsSection': 'productsBtn', 
        'chatSection': 'chatBtn'
    };
    
    if (btnMap[sectionId]) {
        const btn = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
        if (btn) btn.classList.add('active');
    }

    // Cargar datos espec√≠ficos de la secci√≥n
    if (sectionId === 'productsSection') {
        loadProducts();
    }
    if (sectionId === 'chatSection') {
        connectToChat();
    }
}

        // ==================== FUNCIONES DE AUTENTICACI√ìN ====================
async function handleLogin(event) {
    event.preventDefault();
    console.log('üîê Procesando login...');
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const messageEl = document.getElementById('loginMessage');

    if (!email || !password) {
        showMessage(messageEl, '‚ùå Email y contrase√±a son requeridos', 'error');
        return;
    }

    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ email, password })
        });

        console.log('üì® Respuesta login:', response.status);

        let data;
        try {
            data = await response.json();
        } catch (jsonError) {
            console.error('‚ùå Error parseando JSON en login:', jsonError);
            if (response.ok) {
                // Si la respuesta fue exitosa pero no es JSON v√°lido
                showMessage(messageEl, '‚úÖ Login exitoso, procesando...', 'success');
                // Forzar redirecci√≥n
                setTimeout(() => showSection('homeSection'), 1000);
                return;
            } else {
                showMessage(messageEl, '‚ùå Error en el servidor', 'error');
                return;
            }
        }

        if (response.ok) {
            console.log('‚úÖ Login exitoso:', data.user);
            localStorage.setItem('token', data.token);
            currentUser = data.user;
            updateAuthUI(true);
            showSection('homeSection');
            showMessage(messageEl, '‚úÖ ' + (data.message || 'Login exitoso'), 'success');
            document.getElementById('loginForm').reset();
            
            // Reconectar al chat con el nuevo usuario
            connectToChat();
        } else {
            console.log('‚ùå Error en login:', data.error);
            showMessage(messageEl, '‚ùå ' + (data.error || 'Error en el login'), 'error');
        }
    } catch (error) {
        console.error('‚ùå Error de conexi√≥n en login:', error);
        showMessage(messageEl, '‚ùå Error de conexi√≥n con el servidor', 'error');
    }
}

async function handleRegister(event) {
    event.preventDefault();
    console.log('üìù Procesando registro...');
    
    const username = document.getElementById('registerUsername').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const messageEl = document.getElementById('registerMessage');

    // Limpiar mensaje anterior
    showMessage(messageEl, '', '');

    if (!username || !email || !password) {
        showMessage(messageEl, '‚ùå Todos los campos son requeridos', 'error');
        return;
    }

    if (password.length < 6) {
        showMessage(messageEl, '‚ùå La contrase√±a debe tener al menos 6 caracteres', 'error');
        return;
    }

    try {
        console.log('üîÑ Enviando solicitud de registro...');
        
        const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, email, password })
        });

        console.log('üì® Respuesta del servidor:', response.status);

        // Primero intentamos parsear la respuesta como JSON
        let data;
        try {
            data = await response.json();
        } catch (jsonError) {
            console.error('‚ùå Error parseando JSON:', jsonError);
            // Si no se puede parsear como JSON, mostramos un mensaje gen√©rico
            if (response.ok) {
                showMessage(messageEl, '‚úÖ Registro exitoso, pero hubo un problema con la respuesta', 'success');
            } else {
                showMessage(messageEl, '‚ùå Error en el servidor', 'error');
            }
            return;
        }

        if (response.ok) {
            console.log('‚úÖ Registro exitoso:', data.user);
            showMessage(messageEl, '‚úÖ ' + (data.message || 'Registro exitoso!'), 'success');
            document.getElementById('registerForm').reset();
            
            // Auto-login despu√©s del registro exitoso
            setTimeout(() => {
                console.log('üîê Auto-login despu√©s del registro...');
                // Usar las credenciales del registro para hacer login autom√°tico
                document.getElementById('loginEmail').value = email;
                document.getElementById('loginPassword').value = password;
                handleLogin(event);
            }, 1500);
            
        } else {
            console.log('‚ùå Error en registro:', data.error);
            showMessage(messageEl, '‚ùå ' + (data.error || 'Error en el registro'), 'error');
        }
    } catch (error) {
        console.error('‚ùå Error de conexi√≥n en registro:', error);
        // Mostrar mensaje m√°s espec√≠fico seg√∫n el tipo de error
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            showMessage(messageEl, '‚ùå Error de conexi√≥n con el servidor', 'error');
        } else {
            showMessage(messageEl, '‚ùå Error inesperado: ' + error.message, 'error');
        }
    }
}

function logout() {
    console.log('üö™ Cerrando sesi√≥n...');
    localStorage.removeItem('token');
    currentUser = null;
    updateAuthUI(false);
    showSection('homeSection');
    
    if (socket) {
        socket.disconnect();
        socket = null;
    }
    
    // Limpiar lista de usuarios conectados
    updateOnlineUsers({ count: 0, users: [] });
    
    // Actualizar chat para mostrar que el usuario se desconect√≥
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        const systemMessage = document.createElement('div');
        systemMessage.className = 'chat-message system';
        systemMessage.innerHTML = '<strong>Sistema:</strong> Has cerrado sesi√≥n. Inicia sesi√≥n para chatear.';
        chatMessages.appendChild(systemMessage);
    }
}

        function updateAuthUI(isAuthenticated) {
            console.log('üë§ Actualizando UI de autenticaci√≥n:', isAuthenticated);
            
            const loginBtn = document.querySelector('[onclick="showSection(\'loginSection\')"]');
            const registerBtn = document.querySelector('[onclick="showSection(\'registerSection\')"]');
            const logoutBtn = document.getElementById('logoutBtn');
            const userInfo = document.getElementById('userInfo');
            const addProductBtn = document.getElementById('addProductBtn');
            const chatInput = document.getElementById('chatInput');
            const sendMessageBtn = document.getElementById('sendMessageBtn');

            if (isAuthenticated && currentUser) {
                // Usuario autenticado
                if (loginBtn) loginBtn.classList.add('hidden');
                if (registerBtn) registerBtn.classList.add('hidden');
                if (logoutBtn) logoutBtn.classList.remove('hidden');
                if (userInfo) {
                    userInfo.classList.remove('hidden');
                    // Mostrar rol con colores diferentes
                    const roleColor = currentUser.role === 'admin' ? '#ff6b6b' : '#51cf66';
                    const roleIcon = currentUser.role === 'admin' ? 'üëë' : 'üë§';
                    userInfo.innerHTML = `
                        Hola, <strong style="color: white;">${currentUser.username}</strong> 
                        <span style="color: ${roleColor}; font-weight: bold; background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 10px; margin-left: 0.5rem;">${roleIcon} ${currentUser.role.toUpperCase()}</span>
                    `;
                }
                
                if (chatInput) {
                    chatInput.disabled = false;
                    chatInput.placeholder = 'Escribe tu mensaje...';
                }
                if (sendMessageBtn) sendMessageBtn.disabled = false;

                // Mostrar bot√≥n de agregar producto solo para admin
                if (addProductBtn) {
                    if (currentUser.role === 'admin') {
                        addProductBtn.classList.remove('hidden');
                        addProductBtn.innerHTML = 'üëë Agregar Producto';
                        addProductBtn.style.background = '#dc3545';
                    } else {
                        addProductBtn.classList.add('hidden');
                    }
                }

            } else {
                // Usuario no autenticado
                if (loginBtn) loginBtn.classList.remove('hidden');
                if (registerBtn) registerBtn.classList.remove('hidden');
                if (logoutBtn) logoutBtn.classList.add('hidden');
                if (userInfo) userInfo.classList.add('hidden');
                if (addProductBtn) addProductBtn.classList.add('hidden');
                
                if (chatInput) {
                    chatInput.disabled = true;
                    chatInput.placeholder = 'Inicia sesi√≥n para escribir...';
                }
                if (sendMessageBtn) sendMessageBtn.disabled = true;
                
                currentUser = null;
            }
        }

        // ==================== FUNCIONES DE PRODUCTOS ====================
        async function loadProducts() {
            try {
                console.log('üì¶ Cargando productos...');
                const response = await fetch('/api/products');
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                const products = await response.json();
                console.log('‚úÖ Productos recibidos:', products);
                
                if (products.length === 0) {
                    console.log('üì¶ No hay productos, mostrando ejemplos...');
                    displayProducts(getExampleProducts());
                } else {
                    displayProducts(products);
                }
            } catch (error) {
                console.error('‚ùå Error cargando productos:', error);
                console.log('üîÑ Usando productos de ejemplo...');
                displayProducts(getExampleProducts());
            }
        }

        function getExampleProducts() {
            return [
                {
                    _id: '1',
                    name: 'Laptop Gaming Pro',
                    description: 'Laptop de alto rendimiento para gaming y trabajo intensivo con procesador i7 y GPU RTX',
                    price: 1499.99,
                    category: 'Electr√≥nicos',
                    stock: 10,
                    image: '',
                    createdBy: { username: 'Sistema' }
                },
                {
                    _id: '2',
                    name: 'Smartphone Flagship',
                    description: 'Tel√©fono inteligente con c√°mara profesional de 108MP y pantalla AMOLED de 120Hz',
                    price: 899.99,
                    category: 'Electr√≥nicos',
                    stock: 25,
                    image: '',
                    createdBy: { username: 'Sistema' }
                },
                {
                    _id: '3', 
                    name: 'Auriculares Bluetooth',
                    description: 'Auriculares inal√°mbricos con cancelaci√≥n de ruido activa y 30h de bater√≠a',
                    price: 249.99,
                    category: 'Audio',
                    stock: 15,
                    image: '',
                    createdBy: { username: 'Sistema' }
                }
            ];
        }

function displayProducts(products) {
    const productsList = document.getElementById('productsList');
    
    if (!productsList) {
        console.error('‚ùå No se encontr√≥ el elemento productsList');
        return;
    }
    
    if (!products || products.length === 0) {
        productsList.innerHTML = `
            <div class="no-results">
                <h3>üì¶ No se encontraron productos</h3>
                <p style="color: #888; margin-bottom: 2rem;">¬°Prueba con otros t√©rminos de b√∫squeda o filtros!</p>
                <button class="clear-filters" onclick="clearFilters()" style="background: #667eea; padding: 0.75rem 1.5rem;">
                    üîÑ Mostrar Todos los Productos
                </button>
            </div>
        `;
        return;
    }

    // Mostrar badge de admin si es admin
    const adminBadge = currentUser && currentUser.role === 'admin' ? 
        '<div class="admin-badge">üëë MODO ADMINISTRADOR - Puedes editar y eliminar productos</div>' : '';

    productsList.innerHTML = adminBadge + products.map(product => `
        <div class="product-card">
            ${currentUser && currentUser.role === 'admin' ? 
                `<div style="position: absolute; top: 10px; right: 10px; background: #ffc107; color: #856404; padding: 0.25rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: bold;">ID: ${product._id}</div>` : 
                ''
            }
            
            ${product.image ? `<img src="${product.image}" alt="${product.name}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem;" onerror="this.style.display='none'">` : ''}
            
            <h3>${product.name}</h3>
            <p class="description">${product.description}</p>
            <p class="price">$${product.price?.toFixed(2) || '0.00'}</p>
            
            <div style="display: flex; gap: 0.5rem; margin: 0.5rem 0; flex-wrap: wrap;">
                <span style="background: #e9ecef; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem; color: #666;">üìÅ ${product.category}</span>
                <span style="background: #d4edda; padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem; color: #155724;">üì¶ Stock: ${product.stock || 0}</span>
            </div>
            
            ${product.createdBy ? `<p style="font-size: 0.8rem; color: #666; margin-top: 0.5rem; border-top: 1px solid #eee; padding-top: 0.5rem;">üë§ Creado por: ${product.createdBy.username || 'Sistema'}</p>` : ''}
            
            ${currentUser && currentUser.role === 'admin' ? `
                <div class="product-actions">
                    <button class="btn-secondary" onclick="editProduct('${product._id}')">‚úèÔ∏è Editar</button>
                    <button class="btn-danger" onclick="deleteProduct('${product._id}')">üóëÔ∏è Eliminar</button>
                </div>
            ` : ''}
        </div>
    `).join('');
}

        function showProductModal(product = null) {
    if (!currentUser || currentUser.role !== 'admin') {
        alert('‚ùå Solo los administradores pueden gestionar productos');
        return;
    }

    const modal = document.getElementById('productModal');
    const title = document.getElementById('modalTitle');
    
    if (product) {
        title.textContent = 'Editar Producto';
        document.getElementById('productName').value = product.name || '';
        document.getElementById('productDescription').value = product.description || '';
        document.getElementById('productPrice').value = product.price || '';
        document.getElementById('productCategory').value = product.category || '';
        document.getElementById('productStock').value = product.stock || '';
        document.getElementById('productImage').value = product.image || '';
        currentEditingProduct = product._id;
    } else {
        title.textContent = 'Agregar Producto';
        // Limpiar formulario
        document.getElementById('productName').value = '';
        document.getElementById('productDescription').value = '';
        document.getElementById('productPrice').value = '';
        document.getElementById('productCategory').value = '';
        document.getElementById('productStock').value = '';
        document.getElementById('productImage').value = '';
        currentEditingProduct = null;
    }
    
    modal.classList.remove('hidden');
    
    // Hacer focus en el primer campo
    setTimeout(() => {
        document.getElementById('productName').focus();
    }, 100);
}

        function hideProductModal() {
            document.getElementById('productModal').classList.add('hidden');
            currentEditingProduct = null;
        }

        async function handleProductSubmit(event) {
            event.preventDefault();
            
            if (!currentUser || currentUser.role !== 'admin') {
                alert('‚ùå No tienes permisos para esta acci√≥n');
                return;
            }

            const productData = {
                name: document.getElementById('productName').value,
                description: document.getElementById('productDescription').value,
                price: parseFloat(document.getElementById('productPrice').value),
                category: document.getElementById('productCategory').value,
                stock: parseInt(document.getElementById('productStock').value),
                image: document.getElementById('productImage').value
            };

            const token = localStorage.getItem('token');
            const isEditing = currentEditingProduct;

            try {
                const url = isEditing ? `/api/products/${currentEditingProduct}` : '/api/products';
                const method = isEditing ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(productData)
                });

                if (response.ok) {
                    hideProductModal();
                    loadProducts();
                    alert('‚úÖ Producto guardado exitosamente');
                } else {
                    const error = await response.json();
                    alert('‚ùå Error: ' + error.error);
                }
            } catch (error) {
                alert('‚ùå Error de conexi√≥n');
            }
        }

        function editProduct(productId) {
            fetch(`/api/products/${productId}`)
                .then(response => response.json())
                .then(product => {
                    showProductModal(product);
                })
                .catch(error => {
                    alert('‚ùå Error cargando producto');
                });
        }

        function deleteProduct(productId) {
            if (!confirm('¬øEst√°s seguro de que quieres eliminar este producto?')) {
                return;
            }

            const token = localStorage.getItem('token');

            fetch(`/api/products/${productId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (response.ok) {
                    loadProducts();
                    alert('‚úÖ Producto eliminado');
                } else {
                    alert('‚ùå Error eliminando producto');
                }
            })
            .catch(error => {
                alert('‚ùå Error de conexi√≥n');
            });
        }

        // ==================== FUNCIONES DE CHAT MEJORADAS ====================
function connectToChat() {
    console.log('üí¨ Intentando conectar al chat...');
    
    // Verificar que el usuario est√© autenticado
    if (!currentUser) {
        console.log('‚ùå Usuario no autenticado, no se puede conectar al chat');
        
        // Mostrar mensaje en el chat
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.innerHTML = `
                <div class="chat-message system">
                    <strong>Sistema:</strong> üîê Debes <strong>iniciar sesi√≥n</strong> para acceder al chat.
                </div>
            `;
        }
        
        // Deshabilitar completamente el chat
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        if (chatInput) chatInput.disabled = true;
        if (sendMessageBtn) sendMessageBtn.disabled = true;
        if (chatInput) chatInput.placeholder = 'üîê Inicia sesi√≥n para chatear';
        
        return;
    }

    // Desconectar si ya existe una conexi√≥n
    if (socket) {
        socket.disconnect();
        socket = null;
    }

    // Resetear lista de usuarios
    updateOnlineUsers({ count: 0, users: [] });

    // Cargar Socket.IO din√°micamente si no est√° cargado
    if (typeof io === 'undefined') {
        console.log('Cargando Socket.IO...');
        const script = document.createElement('script');
        script.src = '/socket.io/socket.io.js';
        script.onload = initializeChat;
        script.onerror = function() {
            console.error('‚ùå Error cargando Socket.IO');
        };
        document.head.appendChild(script);
    } else {
        initializeChat();
    }
}

function initializeChat() {
    console.log('üîß Inicializando chat...');
    const token = localStorage.getItem('token');
    
    socket = io({
        auth: {
            token: token
        }
    });
    
    socket.on('connect', () => {
        console.log('‚úÖ Conectado al chat');
    });

    socket.on('chatHistory', (messages) => {
        console.log('üì® Historial recibido:', messages.length, 'mensajes');
        displayChatHistory(messages);
    });

    socket.on('newMessage', (message) => {
        console.log('üì® Nuevo mensaje:', message);
        displayNewMessage(message);
    });

    // Manejar "usuarios conectados"
    socket.on('usersOnline', (data) => {
        console.log('üë• Usuarios conectados actualizados:', data);
        updateOnlineUsers(data);
    });

    // Manejar "usuario escribiendo"
    socket.on('userTyping', (data) => {
        showTypingIndicator(data.username);
    });

    // Manejar "usuario dej√≥ de escribir" 
    socket.on('userStoppedTyping', (data) => {
        hideTypingIndicator(data.username);
    });

    socket.on('disconnect', () => {
        console.log('‚ùå Desconectado del chat');
        // Limpiar lista de usuarios cuando nos desconectamos
        updateOnlineUsers({ count: 0, users: [] });
    });

    socket.on('connect_error', (error) => {
        console.error('‚ùå Error de conexi√≥n al chat:', error);
        alert('Error de autenticaci√≥n en el chat. Vuelve a iniciar sesi√≥n.');
        // Limpiar lista de usuarios en caso de error
        updateOnlineUsers({ count: 0, users: [] });
    });
}

        function displayChatHistory(messages) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;
            
            chatMessages.innerHTML = '';
            
            messages.forEach(message => {
                displayNewMessage(message);
            });
        }

        function displayNewMessage(message) {
    const chatMessages = document.getElementById('chatMessages');
    if (!chatMessages) return;
    
    const messageDiv = document.createElement('div');
    const isOwnMessage = currentUser && message.username === currentUser.username;
    
    // Determinar tipo de mensaje
    if (message.type === 'system') {
        messageDiv.className = 'chat-message system';
    } else {
        messageDiv.className = `chat-message ${isOwnMessage ? 'own' : 'other'}`;
    }
    
    // Formatear fecha correctamente
    let timestamp;
    try {
        const date = new Date(message.timestamp);
        timestamp = isNaN(date.getTime()) ? 'Ahora' : date.toLocaleTimeString();
    } catch (error) {
        timestamp = 'Ahora';
    }
    
    // Generar colores √∫nicos para cada usuario
    const userNameColor = getUserColor(message.username);
    const userBackgroundColor = getUserBackgroundColor(message.username);
    const userBorderColor = getUserBorderColor(message.username);
    
    // Determinar si es admin y mostrar badge
    const isAdmin = message.userRole === 'admin';
    const roleBadge = isAdmin ? ' <span style="background: #dc3545; color: white; padding: 0.1rem 0.4rem; border-radius: 10px; font-size: 0.6rem; margin-left: 0.5rem;">ADMIN</span>' : '';
    
    // Aplicar estilos diferentes seg√∫n si es propio o de otro usuario
    if (isOwnMessage) {
        // Mensaje propio - color consistente azul
        messageDiv.style.background = '#667eea';
        messageDiv.style.color = 'white';
        messageDiv.style.marginLeft = 'auto';
        messageDiv.style.borderBottomRightRadius = '4px';
    } else if (message.type === 'system') {
        // Mensaje del sistema
        messageDiv.style.background = '#f8f9fa';
        messageDiv.style.color = '#666';
        messageDiv.style.fontStyle = 'italic';
        messageDiv.style.textAlign = 'center';
        messageDiv.style.border = '1px dashed #dee2e6';
    } else {
        // Mensaje de otro usuario - color √∫nico
        messageDiv.style.background = userBackgroundColor;
        messageDiv.style.border = `1px solid ${userBorderColor}`;
        messageDiv.style.color = '#333';
        messageDiv.style.borderBottomLeftRadius = '4px';
    }
    
    messageDiv.innerHTML = `
        <div style="font-weight: bold; font-size: 0.8rem; margin-bottom: 0.25rem; color: ${isOwnMessage ? 'white' : userNameColor}">
            ${message.username}${roleBadge}
        </div>
        <div style="word-wrap: break-word;">${message.message}</div>
        <div style="text-align: right; font-size: 0.7rem; opacity: 0.7; margin-top: 0.25rem; color: ${isOwnMessage ? 'rgba(255,255,255,0.8)' : '#666'}">
            ${timestamp}
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}
        // Funci√≥n para manejar escritura en tiempo real
        function handleChatInput() {
            const chatInput = document.getElementById('chatInput');
            
            if (!socket || !currentUser) return;
            
            if (!isTyping && chatInput.value.trim() !== '') {
                isTyping = true;
                socket.emit('userTyping');
            }
            
            // Reiniciar timer
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                if (isTyping) {
                    isTyping = false;
                    socket.emit('userStoppedTyping');
                }
            }, 1000);
        }

        function showTypingIndicator(username) {
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) {
        const userColor = getUserColor(username);
        typingIndicator.classList.remove('hidden');
        typingIndicator.innerHTML = `
            <span style="color: ${userColor}; font-weight: bold;">${username}</span> est√° escribiendo...
            <span class="typing-dots">
                <span>.</span><span>.</span><span>.</span>
            </span>
        `;
    }
}

        function hideTypingIndicator(username) {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.classList.add('hidden');
            }
        }

        function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();
            
            if (message && socket) {
                console.log('üì§ Enviando mensaje:', message);
                socket.emit('sendMessage', { 
                    message: message
                });
                chatInput.value = '';
                
                // Notificar que dej√≥ de escribir
                if (isTyping) {
                    isTyping = false;
                    socket.emit('userStoppedTyping');
                }
            } else if (!socket) {
                alert('‚ùå Chat no conectado. Aseg√∫rate de estar autenticado.');
            }
        }

        // ==================== FUNCIONES UTILITARIAS ====================
        function showMessage(element, text, type) {
            if (element) {
                element.textContent = text;
                element.className = `message ${type}`;
                
                setTimeout(() => {
                    element.textContent = '';
                    element.className = 'message';
                }, 5000);
            }
        }

        async function checkAuthStatus() {
            const token = localStorage.getItem('token');
            
            if (!token) {
                updateAuthUI(false);
                return;
            }

            try {
                const response = await fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    updateAuthUI(true);
                } else {
                    localStorage.removeItem('token');
                    updateAuthUI(false);
                }
            } catch (error) {
                localStorage.removeItem('token');
                updateAuthUI(false);
            }
        }

        // ==================== FUNCIONES DE COLORES PARA CHAT ====================

// Funci√≥n para generar un color √∫nico basado en el nombre de usuario
function getUserColor(username) {
    // Generar un hash num√©rico del nombre de usuario
    let hash = 0;
    for (let i = 0; i < username.length; i++) {
        hash = username.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    // Convertir el hash a un color HSL
    const hue = hash % 360;
    
    // Colores m√°s atractivos: saturaci√≥n y luminosidad fijas
    return `hsl(${hue}, 70%, 50%)`;
}

// Funci√≥n para generar un color de fondo m√°s suave para los mensajes
function getUserBackgroundColor(username) {
    let hash = 0;
    for (let i = 0; i < username.length; i++) {
        hash = username.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    const hue = hash % 360;
    // Color de fondo m√°s suave
    return `hsl(${hue}, 50%, 95%)`;
}

// Funci√≥n para generar color de borde
function getUserBorderColor(username) {
    let hash = 0;
    for (let i = 0; i < username.length; i++) {
        hash = username.charCodeAt(i) + ((hash << 5) - hash);
    }
    
    const hue = hash % 360;
    return `hsl(${hue}, 60%, 80%)`;
}

        // ==================== INICIALIZACI√ìN ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Portal de Productos - Inicializando...');
            checkAuthStatus();
            loadProducts();
            
            // Configurar eventos del chat
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
                
                // Agregar evento input para detectar escritura
                chatInput.addEventListener('input', function() {
                    handleChatInput();
                });
            }
        });

        // Fallback si el DOM ya est√° listo
        if (document.readyState === 'complete') {
            console.log('üöÄ Portal de Productos - DOM ya listo, inicializando...');
            checkAuthStatus();
            loadProducts();
        }
    </script>
</body>
</html>